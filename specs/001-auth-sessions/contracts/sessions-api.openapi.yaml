openapi: 3.0.3
info:
  title: MAA Session & Authentication API
  description: |
    Session and authentication endpoints for Medicaid Application Assistant.
    Handles anonymous session creation, session data persistence, encryption, and role-based access control.

    **Phase 1 (MVP)**: Anonymous sessions only. Phase 5 adds authentication/JWT.
    **Base URL**: `https://api.maa.example.com/api`
  version: 1.0.0
  contact:
    name: MAA Development Team
    email: dev@maa.example.com

servers:
  - url: https://api.maa.example.com/api
    description: Production API
  - url: http://localhost:5000/api
    description: Local development

tags:
  - name: Sessions
    description: Session lifecycle management (create, retrieve, update)
  - name: SessionAnswers
    description: Applicant responses within a session
  - name: Health
    description: Service health checks

paths:
  /sessions:
    post:
      summary: Create a new session
      operationId: createSession
      description: |
        Initiates a new anonymous session for an applicant.
        Returns session ID (in Set-Cookie) and initial session state.

        **Business Logic**:
        - Session state = "pending"
        - Timeout = 30 minutes (inactivity)
        - Expires at = NOW + 30 minutes (absolute)
        - No user_id (anonymous until Phase 5 login)
        - Encryption key version = current active key
      tags:
        - Sessions
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                sessionType:
                  type: string
                  enum: [anonymous, authenticated]
                  default: anonymous
                  description: Session type (only 'anonymous' supported in Phase 1)
      responses:
        "201":
          description: Session created successfully
          headers:
            Set-Cookie:
              schema:
                type: string
              description: |
                Session ID cookie. Format: `session_id=UUID; HttpOnly; Secure; SameSite=Strict; Path=/api; Max-Age=1800`
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /sessions/{sessionId}:
    get:
      summary: Retrieve session details
      operationId: getSession
      description: |
        Fetch current session state, timeout info, and permissions.
        Requires valid session ID in cookie.
      tags:
        - Sessions
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session UUID
      responses:
        "200":
          description: Session retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    patch:
      summary: Update session state
      operationId: updateSession
      description: |
        Update session state machine (pending → in_progress → submitted → completed/abandoned).
        Also resets inactivity timeout (sliding window).

        **State Transitions Allowed**:
        - pending → in_progress
        - in_progress → in_progress (no change; resets timeout)
        - in_progress → submitted
        - in_progress/submitted → abandoned
        - submitted → completed (after eligibility determination, Phase 2)
      tags:
        - Sessions
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                state:
                  type: string
                  enum: [pending, in_progress, submitted, completed, abandoned]
                  description: New session state
              required:
                - state
      responses:
        "200":
          description: Session updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionResponse"
        "400":
          description: Invalid state transition
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "409":
          description: Concurrent modification (version conflict)
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Session modified by another request; please retry"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /sessions/{sessionId}/answers:
    post:
      summary: Save applicant answer(s)
      operationId: saveAnswer
      description: |
        Persist one or more applicant responses for a questionnaire field.

        **Business Logic**:
        - Field type determines encryption: 'income' → encrypted, 'age' → plain
        - PII fields (income, ssn, address) → encrypted only
        - Non-PII fields → plain text (no encryption overhead)
        - SSN → dual storage (encrypted + deterministic hash for lookup)
        - Session state must be 'in_progress' or 'submitted'
        - Updates inactivity timeout (sliding window)

        **Validation**: Run field validation rules (e.g., income >= 0, age 0-150)
      tags:
        - SessionAnswers
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/SaveAnswerSingleRequest"
                - $ref: "#/components/schemas/SaveAnswerBatchRequest"
      responses:
        "201":
          description: Answer(s) saved successfully
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: "#/components/schemas/SessionAnswerResponse"
                  - type: array
                    items:
                      $ref: "#/components/schemas/SessionAnswerResponse"
        "400":
          description: Validation error (invalid field type, value out of range, etc.)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationErrorResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          description: Optimistic lock conflict
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Retrieve session answers
      operationId: getAnswers
      description: |
        Fetch all answers submitted for a session (with decryption).
        Useful for wizard "review" page or results calculation.

        **Security Note**: Only returns answers for current session (no cross-session access).
      tags:
        - SessionAnswers
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: fieldKeys
          in: query
          schema:
            type: array
            items:
              type: string
            collectionFormat: csv
          description: Optional filter by field keys (e.g., "income_annual_2025,household_size")
      responses:
        "200":
          description: Answers retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionId:
                    type: string
                    format: uuid
                  answers:
                    type: array
                    items:
                      $ref: "#/components/schemas/SessionAnswerResponse"
                  decryptedAt:
                    type: string
                    format: date-time
                    description: Server timestamp when answers were decrypted
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /sessions/{sessionId}/answers/{answerId}:
    get:
      summary: Retrieve single answer
      operationId: getAnswer
      tags:
        - SessionAnswers
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: answerId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Answer retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionAnswerResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

    delete:
      summary: Delete an answer
      operationId: deleteAnswer
      description: Removes single answer from session (e.g., back button in wizard)
      tags:
        - SessionAnswers
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: answerId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: Answer deleted successfully
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /health/ready:
    get:
      summary: Health check - ready
      operationId: healthReady
      description: |
        Kubernetes readiness probe. Returns 200 if service is ready to accept traffic.
        Checks: database connectivity, Key Vault access.
      tags:
        - Health
      responses:
        "200":
          description: Service ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ready]
                  checks:
                    type: object
                    properties:
                      database:
                        type: string
                        enum: [up, down]
                      keyVault:
                        type: string
                        enum: [up, down]
        "503":
          description: Service not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [not_ready]
                  message:
                    type: string
                    example: "Key Vault unavailable"

  /health/live:
    get:
      summary: Health check - liveness
      operationId: healthLive
      description: Kubernetes liveness probe. Returns 200 if process is alive.
      tags:
        - Health
      responses:
        "200":
          description: Service alive
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [alive]
                  uptime:
                    type: number
                    format: double
                    description: Seconds since startup

  /auth/register:
    post:
      summary: Register a new user account (Phase 5)
      operationId: registerUser
      description: |
        Creates a new user account with email and password.
        Password must be at least 8 characters.
        Email must be unique.

        **Business Logic**:
        - User role = "User" (default for new accounts)
        - Email is encrypted before storage
        - Password is hashed with bcrypt
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
                - fullName
              properties:
                email:
                  type: string
                  format: email
                  description: User email address
                password:
                  type: string
                  format: password
                  minLength: 8
                  description: Password (min 8 chars, must include uppercase, lowercase, digit, special char)
                fullName:
                  type: string
                  description: User full name
      responses:
        "201":
          description: User registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId:
                    type: string
                    format: uuid
                    description: New user ID
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          description: Conflict - Email already registered
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Email is already registered"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/login:
    post:
      summary: Login user with email and password (Phase 5)
      operationId: loginUser
      description: |
        Authenticates user and returns JWT access token + refresh token.
        Refresh token stored in HttpOnly secure cookie.
        Enforces max 3 concurrent sessions per user - returns 409 if exceeded.

        **Business Logic**:
        - Access token expires in 1 hour
        - Refresh token expires in 7 days (HttpOnly cookie)
        - Authenticated session created with 8-hour timeout
        - Max 3 concurrent sessions per user (Phase 5)
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        "200":
          description: Login successful
          headers:
            Set-Cookie:
              schema:
                type: string
              description: |
                Refresh token cookie. Format: `refreshToken=JWT; HttpOnly; Secure; SameSite=Strict; Path=/api; Max-Age=604800`
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: JWT access token (1 hour expiration)
                  tokenType:
                    type: string
                    enum: [Bearer]
                  expiresIn:
                    type: integer
                    format: int32
                    description: Token expiration in seconds (3600 = 1 hour)
                  refreshToken:
                    type: string
                    description: JWT refresh token (7 days expiration) - also in cookie
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          description: Unauthorized - Invalid email or password
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "Invalid email or password"
        "409":
          description: Conflict - Max 3 concurrent sessions exceeded
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "You're logged in on 3 devices. End another session to continue?"
                  activeSessions:
                    type: array
                    items:
                      type: object
                      properties:
                        sessionId:
                          type: string
                          format: uuid
                        device:
                          type: string
                          example: "Chrome on Windows"
                        ipAddress:
                          type: string
                          example: "192.168.1.100"
                        loginTime:
                          type: string
                          format: date-time
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/refresh:
    post:
      summary: Refresh access token using refresh token (Phase 5)
      operationId: refreshToken
      description: |
        Issues new access token using valid refresh token.
        Refresh token can be provided in request body or extracted from cookie.

        **Business Logic**:
        - New access token expires in 1 hour
        - Refresh token remains valid for 7 days
        - Can be called before token expires for pre-emptive refresh
      tags:
        - Authentication
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                refreshToken:
                  type: string
                  description: Refresh token (optional - uses cookie if not provided)
      responses:
        "200":
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  accessToken:
                    type: string
                    description: New JWT access token
                  tokenType:
                    type: string
                    enum: [Bearer]
                  expiresIn:
                    type: integer
                    format: int32
                    description: Token expiration in seconds
        "400":
          description: Bad Request - Refresh token not provided
        "401":
          description: Unauthorized - Refresh token invalid or expired
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/logout:
    post:
      summary: Logout user and revoke session (Phase 5)
      operationId: logoutUser
      description: |
        Invalidates current session and clears refresh token.
        Requires valid access token in Authorization header.

        **Business Logic**:
        - Current session marked as revoked (IsRevoked = true)
        - Refresh token cookie cleared
        - Access token becomes invalid immediately
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Logout successful
          headers:
            Set-Cookie:
              schema:
                type: string
              description: RefreshToken cookie cleared with expires=past
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out successfully"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/sessions:
    get:
      summary: List all active sessions for current user (Phase 5)
      operationId: listUserSessions
      description: |
        Returns list of all active (non-revoked) sessions for authenticated user.
        Useful for showing "logged in on these devices" UI.

        **Business Logic**:
        - Only returns non-revoked, non-expired sessions
        - Ordered by login time (newest first)
        - Max 3 sessions per user enforced at login
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Sessions retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessions:
                    type: array
                    items:
                      type: object
                      properties:
                        sessionId:
                          type: string
                          format: uuid
                          description: Session identifier
                        device:
                          type: string
                          example: "Chrome on Windows"
                          description: Device/browser type extracted from user agent
                        ipAddress:
                          type: string
                          example: "192.168.1.100"
                        loginTime:
                          type: string
                          format: date-time
                        expiresAt:
                          type: string
                          format: date-time
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/sessions/{sessionId}:
    delete:
      summary: Revoke a specific session remotely (Phase 5)
      operationId: revokeSession
      description: |
        Revokes a specific session, logging out that device.
        User can revoke any of their own sessions.
        Useful for "logout from other devices" feature.

        **Business Logic**:
        - Session marked as revoked (IsRevoked = true)
        - Session immediately becomes invalid
        - User on that device must login again
      tags:
        - Authentication
      security:
        - BearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
          description: Session ID to revoke
      responses:
        "200":
          description: Session revoked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Session revoked"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Session not found or doesn't belong to user
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  schemas:
    SessionResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: Unique session identifier
        state:
          type: string
          enum: [pending, in_progress, submitted, completed, abandoned]
          description: Current session state
        userId:
          type: string
          format: uuid
          nullable: true
          description: Applicant user ID (null for anonymous sessions)
        sessionType:
          type: string
          enum: [anonymous, authenticated]
          description: Session type
        expiresAt:
          type: string
          format: date-time
          description: Absolute session expiry timestamp
        inactivityTimeoutAt:
          type: string
          format: date-time
          description: Inactivity timeout timestamp (sliding window)
        isRevoked:
          type: boolean
          description: Whether session was explicitly revoked
        ipAddress:
          type: string
          description: Client IP address (for tracking)
        userAgent:
          type: string
          description: Browser user agent string
        lastActivityAt:
          type: string
          format: date-time
          description: Timestamp of last request
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    SessionAnswerResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
        sessionId:
          type: string
          format: uuid
        fieldKey:
          type: string
          description: Questionnaire field identifier (e.g., "income_annual_2025")
        fieldType:
          type: string
          enum: [text, number, date, currency, address, select, radio, checkbox]
          description: Data type of answer
        answer:
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: array
          description: Decrypted answer value (for display)
        isPii:
          type: boolean
          description: Whether this field contains personally identifiable information
        validationErrors:
          type: array
          items:
            type: string
          description: Array of validation error messages (empty if valid)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    SaveAnswerSingleRequest:
      type: object
      required:
        - fieldKey
        - fieldType
        - answer
      properties:
        fieldKey:
          type: string
          description: Questionnaire field identifier
        fieldType:
          type: string
          enum: [text, number, date, currency, address, select, radio, checkbox]
        answer:
          oneOf:
            - type: string
            - type: number
            - type: boolean
            - type: array
          description: Answer value
        isPii:
          type: boolean
          default: false
          description: Is this field personally identifiable?

    SaveAnswerBatchRequest:
      type: object
      required:
        - answers
      properties:
        answers:
          type: array
          minItems: 1
          items:
            $ref: "#/components/schemas/SaveAnswerSingleRequest"

    ValidationErrorResponse:
      type: object
      properties:
        error:
          type: string
          enum: [ValidationError]
        message:
          type: string
          description: Human-readable error message
        validationErrors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
          description: Machine-readable errors by field
          example:
            income_annual_2025: ["must be >= 0", "must be <= 9999999"]
            ssn: ["must be 9 digits", "already exists in system"]

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error code
        message:
          type: string
          description: Human-readable error message
        traceId:
          type: string
          description: Correlation ID for debugging

  responses:
    BadRequest:
      description: Bad request (invalid parameters)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    Unauthorized:
      description: |
        Unauthorized. Session ID missing or invalid.

        Causes:
        - Session ID cookie not present
        - Session ID not found in database
        - Session expired (compared to expires_at)
        - Session revoked (is_revoked = true)
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

    InternalServerError:
      description: |
        Internal server error.

        Possible causes:
        - Database unreachable
        - Key Vault unavailable (encryption key unavailable)
        - Encryption/decryption failure
        - Unexpected exception
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  securitySchemes:
    SessionCookie:
      type: apiKey
      in: cookie
      name: session_id
      description: Session ID cookie (HTTP-only) - Phase 1, anonymous sessions
    
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT bearer token for authenticated users (Phase 5).
        Access token issued by /auth/login endpoint.
        Format: Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        Token expires in 1 hour - use /auth/refresh to obtain new token.

security:
  - SessionCookie: []

x-phase-5-notes: |
  **Phase 5 (US5) Authentication Implementation Notes**:

  1. **JWT Tokens**:
     - Access token: 1 hour expiration, Bearer authentication
     - Refresh token: 7 days expiration, stored in HttpOnly cookie
     - Auto-refresh: Client gets X-New-Access-Token header if token was refreshed mid-request

  2. **Concurrent Sessions**:
     - Max 3 concurrent sessions per user
     - Fourth login returns 409 Conflict with active session list
     - Users can revoke sessions remotely via DELETE /api/auth/sessions/{sessionId}

  3. **Auto-Refresh Middleware**:
     - JwtRefreshMiddleware checks if token expires in <5 minutes
     - Automatically refreshes if refresh token is valid
     - Client receives new token in X-New-Access-Token response header

  4. **Security**:
     - Refresh tokens in HttpOnly, Secure, SameSite=Strict cookies
     - No access tokens in cookies (mitigates XSS attacks)
     - HTTPS enforced (Secure flag)

x-phase-1-notes: |
  **Phase 1 (MVP) Implementation Notes**:

  1. **Authentication (Phase 1)**: Only anonymous sessions supported.
     - No JWT tokens / bearer authorization yet (Phase 5)
     - Sessions identified solely by session_id cookie

  2. **Encryption (Phase 1)**: PII fields encrypted before database storage.
     - Income, assets, disability status → randomized encryption
     - SSN → dual storage (encrypted + deterministic hash)
     - Non-PII fields → plain text
     - See data-model.md for detail

  3. **Timeouts (Phase 1)**: Fixed 30-minute inactivity timeout.
     - No sliding window implementation yet
     - Timeout resets on any request (GET or POST to /api/sessions/{id})
     - See project plan for Phase 5 sliding window implementation

  4. **Concurrency (Phase 1)**: Optimistic locking (version column).
     - Last write wins on conflict
     - Exception: State transitions validated server-side (pending→in_progress enforced)

  5. **Error Handling**: All 5xx errors include traceId for correlation with monitoring logs.

  6. **Rate Limiting (Phase 3)**: Not implemented in Phase 1.
     - Plan: 10 requests/second per session (prevent brute-force attacks)

  7. **Logging**: All session operations logged to Application Insights.
     - Session creation, state changes, answer submission logged with PII scrubbing
     - Encryption operations logged at DEBUG level only (performance)

  8. **CORS (Phase 2)**: Not needed for Phase 1 (SPA on same domain).
     - Will add when frontend assets move to separate origin
