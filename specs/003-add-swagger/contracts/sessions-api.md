# OpenAPI Schema: Sessions Endpoints

**Purpose**: Documented API contract for session management endpoints  
**Format**: OpenAPI 3.0.1 (machine-readable schema)
**Status**: Specification (to be generated via Swashbuckle in implementation)

## Overview

This document defines the API contract for endpoints related to session management. The actual OpenAPI JSON/YAML will be auto-generated by Swashbuckle during build.

---

## Endpoints

### GET /api/sessions/{sessionId}

**Summary**: Retrieve a specific session and its metadata

**Parameters**:

- `sessionId` (path, required, string): UUID of the session to retrieve

**Security**: Requires JWT Bearer token (Authorization header)

**Responses**:

| Status | Description                             | Schema         |
| ------ | --------------------------------------- | -------------- |
| 200    | Session retrieved successfully          | SessionDto     |
| 400    | Invalid session ID format               | ProblemDetails |
| 401    | Missing or invalid authentication token | ProblemDetails |
| 404    | Session not found or user lacks access  | ProblemDetails |
| 500    | Server error                            | ProblemDetails |

**Example Request**:

```
GET /api/sessions/550e8400-e29b-41d4-a716-446655440000
Authorization: Bearer {jwt_token}
```

**Example Response (200)**:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "state": "draft",
  "userId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
  "sessionType": "anonymous",
  "encryptionKeyVersion": 1,
  "expiresAt": "2026-02-10T18:30:00Z",
  "inactivityTimeoutAt": "2026-02-10T11:00:00Z",
  "lastActivityAt": "2026-02-10T10:45:00Z",
  "isRevoked": false,
  "createdAt": "2026-02-10T10:30:00Z",
  "updatedAt": "2026-02-10T10:45:00Z",
  "isValid": true,
  "minutesUntilExpiry": 480,
  "minutesUntilInactivityTimeout": 15
}
```

**Example Response (404)**:

```json
{
  "type": "https://tools.ietf.org/html/rfc7231#section-6.5.4",
  "title": "Session Not Found",
  "status": 404,
  "detail": "Session with ID 550e8400-e29b-41d4-a716-446655440000 not found",
  "traceId": "00-..."
}
```

---

### POST /api/sessions

**Summary**: Create a new session

**Request Body**:

- `ipAddress` (string, required): Client IP address (optional; server will derive if omitted)
- `userAgent` (string, required): Browser user agent (optional; server will derive if omitted)
- `timeoutMinutes` (integer, optional): Absolute session timeout (default 30)
- `inactivityTimeoutMinutes` (integer, optional): Sliding inactivity timeout (default 15)

**Security**: Requires JWT Bearer token

**Responses**:

| Status | Description                  | Schema         |
| ------ | ---------------------------- | -------------- |
| 201    | Session created successfully | SessionDto     |
| 400    | Invalid request body         | ProblemDetails |
| 401    | Unauthorized                 | ProblemDetails |
| 500    | Server error                 | ProblemDetails |

**Example Request**:

```
POST /api/sessions
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
  "timeoutMinutes": 30,
  "inactivityTimeoutMinutes": 15
}
```

**Example Response (201)**:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "state": "draft",
  "userId": null,
  "ipAddress": "192.168.1.100",
  "userAgent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
  "sessionType": "anonymous",
  "encryptionKeyVersion": 1,
  "expiresAt": "2026-02-10T18:30:00Z",
  "inactivityTimeoutAt": "2026-02-10T11:00:00Z",
  "lastActivityAt": "2026-02-10T10:30:00Z",
  "isRevoked": false,
  "createdAt": "2026-02-10T10:30:00Z",
  "updatedAt": "2026-02-10T10:30:00Z",
  "isValid": true,
  "minutesUntilExpiry": 480,
  "minutesUntilInactivityTimeout": 15
}
```

---

### POST /api/sessions/{sessionId}/answers

**Summary**: Add or update an answer to a question in a session

**Path Parameters**:

- `sessionId` (string, required, UUID): Session to add answer to

**Request Body**:

- `fieldKey` (string, required): Question identifier
- `fieldType` (enum, required): "currency", "integer", "string", "boolean", "date", "text"
- `answerValue` (string, required): User's response (plain text representation)
- `isPii` (boolean, required): Whether the field contains PII

**Security**: Requires JWT Bearer token

**Responses**:

| Status | Description                               | Schema           |
| ------ | ----------------------------------------- | ---------------- |
| 201    | Answer saved successfully                 | SessionAnswerDto |
| 400    | Invalid request body or validation failed | ProblemDetails   |
| 401    | Unauthorized                              | ProblemDetails   |
| 404    | Session not found                         | ProblemDetails   |
| 500    | Server error                              | ProblemDetails   |

**Example Request**:

```
POST /api/sessions/550e8400-e29b-41d4-a716-446655440000/answers
Authorization: Bearer {jwt_token}
Content-Type: application/json

{
  "fieldKey": "income_annual",
  "fieldType": "currency",
  "answerValue": "45000.00",
  "isPii": true
}
```

**Example Response (200)**:

```json
{
  "id": "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "fieldKey": "income_annual",
  "fieldType": "currency",
  "answerValue": "45000.00",
  "isPii": true,
  "keyVersion": 1,
  "validationErrors": null,
  "createdAt": "2026-02-10T10:32:00Z",
  "updatedAt": "2026-02-10T10:32:00Z"
}
```

**Example Response (400)**:

```json
{
  "isValid": false,
  "code": "VALIDATION_ERROR",
  "message": "Validation failed. See errors for details.",
  "errors": [
    {
      "field": "answerValue",
      "message": "Annual income must be a non-negative number"
    }
  ]
}
```

---

### GET /api/sessions/{sessionId}/answers

**Summary**: Retrieve all answers for a session

**Path Parameters**:

- `sessionId` (string, required, UUID): Session to retrieve answers for

**Security**: Requires JWT Bearer token

**Responses**:

| Status | Description                    | Schema                    |
| ------ | ------------------------------ | ------------------------- |
| 200    | Answers retrieved successfully | Array of SessionAnswerDto |
| 401    | Unauthorized                   | ProblemDetails            |
| 404    | Session not found              | ProblemDetails            |
| 500    | Server error                   | ProblemDetails            |

**Example Request**:

```
GET /api/sessions/550e8400-e29b-41d4-a716-446655440000/answers?skip=0&take=50
Authorization: Bearer {jwt_token}
```

**Example Response (200)**:

```json
[
  {
    "answerId": "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
    "sessionId": "550e8400-e29b-41d4-a716-446655440000",
    "questionId": "annual_income",
    "answerValue": 45000,
    "dataType": "number",
    "createdAt": "2026-02-10T10:32:00Z",
    "updatedAt": "2026-02-10T10:32:00Z"
  },
  {
    "answerId": "b2c3d4e5-f6g7-8h9i-0j1k-l2m3n4o5p6q7",
    "sessionId": "550e8400-e29b-41d4-a716-446655440000",
    "questionId": "num_dependents",
    "answerValue": 2,
    "dataType": "number",
    "createdAt": "2026-02-10T10:33:00Z",
    "updatedAt": "2026-02-10T10:33:00Z"
  }
]
```

---

### GET /api/sessions/{sessionId}/export

**Summary**: Export complete session data including answers and metadata

**Path Parameters**:

- `sessionId` (string, required, UUID): Session to export

**Query Parameters**:

- `format` (enum, optional): "json" (default) or "csv"

**Security**: Requires JWT Bearer token

**Responses**:

| Status | Description                   | Schema           |
| ------ | ----------------------------- | ---------------- |
| 200    | Session exported successfully | SessionData      |
| 401    | Unauthorized                  | ValidationResult |
| 404    | Session not found             | ValidationResult |
| 500    | Server error                  | ValidationResult |

**Example Request**:

```
GET /api/sessions/550e8400-e29b-41d4-a716-446655440000/export
Authorization: Bearer {jwt_token}
```

**Example Response (200)**:

```json
{
  "sessionId": "550e8400-e29b-41d4-a716-446655440000",
  "userId": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "exportedAt": "2026-02-10T15:00:00Z",
  "sessionMetadata": {
    "startedAt": "2026-02-10T10:30:00Z"
  },
  "answers": [
    {
      "answerId": "a1b2c3d4-e5f6-7g8h-9i0j-k1l2m3n4o5p6",
      "sessionId": "550e8400-e29b-41d4-a716-446655440000",
      "questionId": "annual_income",
      "answerValue": 45000,
      "dataType": "number"
    }
  ],
  "eligibilityResults": {}
}
```

---

## Security Scheme

**Type**: HTTP Bearer (JWT)

**Scheme**: `Bearer`

**Bearer Format**: JWT (JSON Web Token)

**Header**: `Authorization: Bearer {token}`

**Example JWT Payload**:

```json
{
  "sub": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
  "email": "user@example.com",
  "role": "Applicant",
  "iat": 1707573000,
  "exp": 1707659400
}
```

---

## Error Response Format

All error responses follow this standardized format:

```json
{
  "isValid": false,
  "code": "ERROR_CODE",
  "message": "Human-readable explanation of what went wrong",
  "errors": [
    {
      "field": "fieldName",
      "message": "Explanation and remediation guidance"
    }
  ]
}
```

**Common Error Codes**:

- `VALIDATION_ERROR`: Request validation failed
- `AUTHENTICATION_FAILED`: JWT token invalid or expired
- `AUTHORIZATION_DENIED`: User lacks permission to access resource
- `NOT_FOUND`: Resource does not exist
- `INTERNAL_ERROR`: Unexpected server error

---

## Notes

- All timestamps are ISO 8601 format (UTC/Z)
- All UUIDs are in standard RFC 4122 format
- Content-Type for all responses is `application/json`
- Pagination defaults to 100 items; maximum 1000 per request
- Rate limiting: 1000 requests per minute (per user)
